#!/usr/bin/env bash
set -eo pipefail

echo "---> Ruby Buildpack"

layersdir=${1}
nginxlayer="${layersdir}"/nginx
mkdir -p "${nginxlayer}"

echo "Extracting nginx"
tar xzvf nginx-upload-module-2.3.0.tar.gz
rm nginx-upload-module-2.3.0.tar.gz

tar xzvf nginx-1.16.1.tar.gz
rm nginx-1.16.1.tar.gz

tar xzvf pcre-8.42.tar.gz
rm pcre-8.42.tar.gz

echo "Patching nginx-upload-module"
pushd nginx-upload-module-2.3.0 > /dev/null
    patch < ../upload_module_put_support.patch
popd

echo "Making nginx"
pushd nginx-1.16.1 > /dev/null
    ./configure \
        --prefix="${nginxlayer}" \
        --sbin-path="${nginxlayer}/bin/nginx" \
        --with-debug \
        --with-pcre=../pcre-8.42 \
        --add-module=../nginx-upload-module-2.3.0
    make -j $(nproc)
    make -j $(nproc) install
popd

rm -rf *

export PATH="${nginxlayer}"/sbin:$PATH

echo -e 'launch = true' > "${nginxlayer}.toml"

# Set default start command
cat > "${layersdir}/launch.toml" <<EOL
[[processes]]
type = "web"
command = "nginx -g 'daemon off;' -c /etc/nginx/nginx.conf"
EOL
